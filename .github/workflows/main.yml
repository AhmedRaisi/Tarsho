name: Continuous Integration

on:
  push:
    branches: [ main ]       # Triggers on a push to the main branch
  pull_request:
    branches: [ main ]       # Also triggers on pull requests to the main branch

jobs:
  build-compose:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v2

    - name: Set up Node.js
      uses: actions/setup-node@v2
      with:
        node-version: '16'

    - name: Build Docker Compose Environment
      run: ./ci/build-compose.sh

  frontend-tests:
    needs: build-compose
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v2

    - name: Build Frontend Docker Image
      run: ./ci/build-frontend.sh

    - name: Install Frontend Dependencies
      run: npm ci
      working-directory: ./web

    - name: Run Frontend Tests
      run: npm test
      working-directory: ./web

  backend-tests:
    needs: frontend-tests
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v2

    - name: Build Backend Docker Image
      run: ./ci/build-backend.sh

    - name: Start Services
      run: docker-compose -f docker-compose.test.yml up -d
    
    - name: List Docker Containers
      run: docker ps --format "{{.Names}}"

    - name: Run Backend Tests
      run: |
        docker exec tarsho_backend_1 sh -c "npm test"
      # Replace 'tarsho_backend_1' with the correct container name.

    - name: Shutdown Test Services
      run: docker-compose -f docker-compose.test.yml down
